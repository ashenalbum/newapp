<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<meta name="format-detection" content="telephone=no" />
	<title>学生</title>
	<link rel="stylesheet" href="../../css/api.css">
	<link rel="stylesheet" href="../../css/style.css">
    <style>
        html,body{background:rgba(0,0,0,1);}
        .btns{position:fixed; bottom:0; left:0; right:0;}
        .btns .btn{height:100px; min-width:64px;}
        .btns .btn .img{display:block; width:56px; height:56px;}
    </style>
</head>
<body class="df df-c">
    <div id="header"></div>
    <div class="btns df just-c-aro fs-14 c-ff">
        <div id="btn1" class="btn fc df df-c ai-c hide">
            <img src="../../image/rong/call3.png" class="img" onclick="chengCamera()"/>
            <div class="mt-10 fs-12">转换摄像头</div>
        </div>
        <div id="btn2" class="btn fc df df-c ai-c">
            <img src="../../image/rong/call2.png" class="img" onclick="guaduan()"/>
        </div>
        <div id="btn3" class="btn fc df df-c ai-c">
            <img src="../../image/rong/call1.png" class="img" onclick="jieting()"/>
        </div>
        <div id="btn4" class="btn fc df df-c ai-c hide">
            <img src="../../image/rong/call6.png" class="img" />
            <div class="mt-10 fs-12">静音</div>
        </div>
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/zepto.min.js"></script>
<script type="text/javascript" src="../../script/rong.js"></script>
<script>
var jtTime = 0;
var sound = true;
var miantibtn = true;
apiready = function(){
    // var header = $api.byId('header');
    // var headerH = $api.fixStatusBar(header);
    setEvent();
}
function setEvent(){
    RY.init();
    api.addEventListener({name: 'ronghangup'}, function(ret, err){
        api.toast({msg: '通话结束',global:true});
        RY.rong.removeVideoView({userId:RY.uinfo.userId});
        RY.rong.removeVideoView({userId:api.pageParam.uid});
        myApp.ajax({
            url: "/api/zixun/zhuanjiamem/endyuyue",
            method: "get",
            data: {id:api.pageParam.yyid, starttime:jtTime},
            success(data){
                if(data.errcode!=0 && data.errcode!=200){return}
                if(data.data.sta==1){
                    var order = data.data.id;
                    myApp.alert({
                        title: "通话时长超出",
                        content: '还需支付'+data.data.bcprice+'贝',
                        callback(){
                            myApp.inputPayPwd(function(pwd){pay(pwd,order)});
                        }
                    });
                } else if(data.data.sta==2){
                    api.toast({msg:"超出通话费用将退还至余额", global:true});
                    toEvaluate();
                    setTimeout(function(){api.closeWin()},500);
                } else {
                    api.toast({msg:"通话结束", global:true});
                    toEvaluate();
                    setTimeout(function(){api.closeWin()},500);
                }
            }
        })
    });
    api.addEventListener({name: 'rongacceptok'}, function(ret, err){
        if( !ret ){api.toast({msg:JSON.stringify( err ), global:true});return}
        jtTime = Date.now();
        RY.rong.getCallSession(function(ret){
            if(ret.mediaType=='audio'){return}
            var uid = ret.callerUserId;
            RY.rong.setVideoView({
                userId: uid,
                renderModel: 'adaptive',
                bg:'#fff',
                fixed: true
            });
            RY.rong.setVideoView({
                userId: RY.uinfo.userId,
                rect: {x:api.frameWidth-110, y:10, w:100, h:150},
                renderModel: 'adaptive',
                bg:'#fff',
                fixed: true
            });
        });
    });
}
// 支付
function pay(pwd,order){
    myApp.ajax({
        url: "/api/member/member/payorder",
        method: "get",
        data: {id:order, paypwd:pwd},
        success(data){
            if(data.errcode!=0 && data.errcode!=200){return}
            api.toast({msg:"支付成功",global:true});
            setTimeout(toEvaluate,2000);
        }
    });
}
// 接听
function jieting(){
    RY.rong.accept();
    $("#btn3").addClass("hide");
    $("#btn1").removeClass("hide");
    $("#btn4").removeClass("hide");
    jtTime = Date.now();
}
// 挂断
function off(){RY.rong.hangup()}
// 静音
function setMuted(){
    RY.rong.setMuted({muted:sound},function(ret){ret.status && $("#btn4 .img").attr("src","../../image/rong/"+(sound?"call5.png":"call4.png"))});
    sound = !sound;
}
// 切换摄像头
function changeCamera(){rong.switchCameraMode(function(ret){ret.status && api.toast({msg:"切换成功"})})}
// 评价
function toEvaluate(){myApp.openWin({title:"评价", url: "/html/consult/expert_evaluate.html", pageParam: {yyid:api.pageParam.yyid}})}
</script>
</html>
